<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Creador de Pinouts para PCB v23.7 (Selección de Grupo Mejorada)</title>
    <style>
        :root {
            --editor-bg: #333;
            --panel-bg: #ffffff;
            --border-color: #cccccc;
            --shadow-color: rgba(0,0,0,0.15);
            --text-color: #333333;
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --selection-border: #ff5722;
            --image-selection-color: #007bff;
            --group-selection-color: #9c27b0; /* Púrpura para grupos */
        }

        /* --- ESTRUCTURA PRINCIPAL Y PANELES --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            margin: 0;
            height: 100vh;
            background-color: var(--editor-bg);
            color: var(--text-color);
            overflow: hidden;
        }
        
        * { box-sizing: border-box; }

        .side-panel {
            width: 260px;
            padding: 20px;
            background-color: var(--panel-bg);
            box-shadow: 0 0 10px var(--shadow-color);
            z-index: 20;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .side-panel h2, .side-panel h3 {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            margin-bottom: 15px;
        }
        .side-panel h2:first-child, .side-panel h3:first-child {
            margin-top: 0;
            border-top: none;
            padding-top: 0;
        }

        /* --- CONTROLES GENÉRICOS --- */
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; }
        .control-group input[type="text"], .control-group input[type="number"] { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; }
        .control-group input[type="color"] { width: 100%; height: 40px; padding: 2px; border: 1px solid var(--border-color); background: none; cursor: pointer; }
        button { width: 100%; padding: 10px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        .tool-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 5px; }
        .tool-grid button, .tool-row button { background-color: var(--secondary-color); padding: 8px; font-size: 1em; line-height: 1; }
        .tool-grid button:hover, .tool-row button:hover { background-color: #5a6268; }
        .tool-row { display: flex; gap: 5px; margin-top: 10px; align-items: center; }
        .tool-row button { flex: 1; font-size: 0.9em; }

        /* --- PANELES CONTEXTUALES (DERECHA) --- */
        #pin-editor, #alignment-tools, #delete-selection-btn { display: none; }
        
        /* --- ÁREA DEL EDITOR Y MESA DE TRABAJO --- */
        #editor-area { flex-grow: 1; position: relative; overflow: hidden; cursor: default; }
        #editor-area.panning { cursor: grabbing; }
        #artboard { position: absolute; background-color: #FFFFFF; box-shadow: 0 0 20px rgba(0,0,0,0.5); transform-origin: 0 0; overflow: hidden; }
        .artboard-resize-handle { position: absolute; width: 12px; height: 12px; background-color: var(--primary-color); border: 2px solid white; border-radius: 2px; z-index: 150; bottom: -6px; right: -6px; cursor: se-resize; }
        
        /* --- IMAGEN Y SELECCIÓN --- */
        .image-wrapper { position: absolute; cursor: grab; border: 2px dashed transparent; }
        .image-wrapper.selected { border-color: var(--image-selection-color); z-index: 50; }
        .image-wrapper img { display: block; width: 100%; height: 100%; pointer-events: none; }
        .image-wrapper .image-resize-handle { position: absolute; width: 10px; height: 10px; background: white; border: 1px solid #333; bottom: -5px; right: -5px; cursor: se-resize; display: none; }
        .image-wrapper.selected .image-resize-handle { display: block; }
        #selection-box { position: absolute; border: 1px dashed var(--primary-color); background-color: rgba(0, 123, 255, 0.2); z-index: 1000; display: none; }
        
        /* --- ESTILOS DE GRUPO --- */
        .group-wrapper { position: absolute; border: 2px dashed transparent; cursor: grab; }
        .group-wrapper.selected { border-color: var(--group-selection-color); z-index: 40; }
        
        /* --- ESTILOS DE PIN MULTI-FUNCIÓN --- */
        .pin { position: absolute; display: flex; align-items: stretch; border: 1px solid #aaa; border-radius: 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); cursor: grab; font-size: 14px; user-select: none; z-index: 10; width: max-content; height: var(--pin-grosor, 22px); }
        .pin.selected { border: 2px solid var(--selection-border); z-index: 100; }
        .pin-id { display: flex; justify-content: center; align-items: center; padding: 6px 10px; font-weight: bold; color: white; background-color: #777; border-radius: 3px 0 0 3px; }
        .pin.vertical { flex-direction: column; height: max-content; width: var(--pin-grosor, 22px); }
        .pin.vertical .pin-id { border-radius: 3px 3px 0 0; width: 100%; }
        .pin.vertical .pin-id span { writing-mode: vertical-rl; transform: rotate(180deg); text-orientation: mixed; }
        .pin.flipped { flex-direction: row-reverse; }
        .pin.flipped .pin-id { border-radius: 0 3px 3px 0; }
        .pin.vertical.flipped { flex-direction: column-reverse; }
        .pin.vertical.flipped .pin-id { border-radius: 0 0 3px 3px; }
        .pin.vertical.flipped .pin-label-container { border-radius: 3px 3px 0 0; }
        .pin-label-container { display: flex; flex-direction: row; align-items: stretch; background-color: #f0f0f0; border-radius: 0 3px 3px 0; overflow: hidden; width: max-content; }
        .pin-function { display: flex; align-items: center; justify-content: center; padding: 0 10px; white-space: nowrap; border-right: 1px solid rgba(0,0,0,0.1); color: #333; }
        .pin-function:last-child { border-right: none; }
        .pin.vertical .pin-label-container { flex-direction: column; height: max-content; width: 100%; }
        .pin.vertical .pin-function { border-right: none; border-bottom: 1px solid rgba(0,0,0,0.1); padding: 10px 0; width: 100%; }
        .pin.vertical .pin-function:last-child { border-bottom: none; }
        .pin.vertical .pin-function span { writing-mode: vertical-rl; transform: rotate(180deg); text-orientation: mixed; }

        /* --- EDITOR DE FUNCIONES (PANEL DERECHO) --- */
        .function-editor-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; background-color: #f9f9f9; padding: 8px; border-radius: 4px; }
        .function-editor-row input[type="text"] { flex-grow: 1; }
        .function-editor-row input[type="color"] { width: 32px; height: 32px; padding: 2px; flex-shrink: 0; border: 1px solid var(--border-color); }
        .function-editor-row .delete-function-btn { background-color: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 12px; line-height: 24px; padding: 0; flex-shrink: 0; cursor: pointer; }
    </style>
</head>
<body>

    <div id="left-properties-panel" class="side-panel">
        <h2>Propiedades</h2>
        <h3>Mesa de Trabajo</h3>
        <div class="control-group"><label for="artboard-width">Ancho (px)</label><input type="number" id="artboard-width" value="800" min="10"></div>
        <div class="control-group"><label for="artboard-height">Alto (px)</label><input type="number" id="artboard-height" value="600" min="10"></div>
        <div class="control-group"><label for="artboard-bg-color">Color de Fondo</label><input type="color" id="artboard-bg-color" value="#FFFFFF"></div>
    </div>

    <div id="editor-area">
        <div id="selection-box"></div>
        <div id="artboard"><div class="artboard-resize-handle"></div></div>
    </div>

    <div id="right-toolbar-panel" class="side-panel">
        <h2>Archivo</h2>
        <div class="control-group"><button id="save-project-btn">Guardar Proyecto (.pop)</button></div>
        <div class="control-group">
            <button id="load-project-btn">Cargar Proyecto (.pop)</button>
            <input type="file" id="project-loader" accept=".pop,.json" style="display: none;">
        </div>
        <div class="control-group"><button id="save-image-btn">Exportar como PNG</button></div>
        
        <h2>Herramientas</h2>
        <h3>Añadir Elementos</h3>
        <div class="control-group"><label for="image-loader">Cargar Imagen</label><input type="file" id="image-loader" accept="image/*" multiple></div>
        <div class="control-group"><label for="num-pins">Número de Pines</label><input type="number" id="num-pins" value="8" min="1"></div>
        <div class="control-group"><label for="num-rows">Número de Filas</label><input type="number" id="num-rows" value="1" min="1"></div>
        <button id="add-header-btn">Añadir Cabecera</button>

        <div id="alignment-tools">
            <h3>Organizar Selección</h3>
            <div class="control-group pin-specific-control"><label for="selection-thickness-input">Grosor de Pin (px)</label><input type="number" id="selection-thickness-input" min="10" placeholder="22"></div>
            <div class="control-group" id="grouping-tools"><label>Agrupar</label><div class="tool-row"><button id="group-btn">Agrupar</button><button id="ungroup-btn">Desagrupar</button></div></div>
            <div class="control-group"><label>Alinear</label><div class="tool-grid"><button id="align-left-btn" title="Alinear a la Izquierda">←</button><button id="align-vcenter-btn" title="Alinear Centros Verticales">_</button><button id="align-right-btn" title="Alinear a la Derecha">→</button><button id="align-top-btn" title="Alinear Arriba">↑</button><button id="align-hcenter-btn" title="Alinear Centros Horizontales">|</button><button id="align-bottom-btn" title="Alinear Abajo">↓</button></div></div>
            <div class="control-group"><label>Distribuir (3+)</label><div class="tool-row"><button id="distribute-h-btn">Horizontal</button><button id="distribute-v-btn">Vertical</button></div></div>
            <div class="control-group"><label for="tidy-gap-input">Ordenar con Espacio (px)</label><div class="tool-row"><input type="number" id="tidy-gap-input" value="10" min="0" style="width: 70px; text-align: center;"><button id="tidy-h-btn">Horizontal</button><button id="tidy-v-btn">Vertical</button></div></div>
            <div class="control-group"><label>Acciones</label><div class="tool-row"><button id="rotate-selection-btn">Girar ↻</button><button id="flip-selection-btn">Espejo ⇄</button></div></div>
        </div>
        
        <div id="pin-editor">
            <h3>Editar Pin</h3>
            <div class="control-group"><label for="pin-id-text">Etiqueta de Pin (ej: P1)</label><input type="text" id="pin-id-text"></div>
            <div class="control-group"><label>Funciones</label><div id="pin-functions-list"></div></div>
            <div class="control-group"><button id="add-function-btn">+ Añadir Función</button></div>
            <div class="control-group"><label>Acciones del Pin</label><div class="tool-row"><button id="rotate-pin-btn">Girar ↻</button><button id="flip-pin-btn">Espejo ⇄</button></div></div>
        </div>

        <button id="delete-selection-btn" class="danger">Eliminar Selección</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Referencias a Elementos y Estado ---
        const editorArea = document.getElementById('editor-area');
        const artboard = document.getElementById('artboard');
        const selectionBox = document.getElementById('selection-box');
        let selectionGroup = [];
        let viewScale = 1, viewTranslateX = 0, viewTranslateY = 0;
        let isPanning = false, isDragging = false, isSelecting = false, isResizingArtboard = false, isResizingImage = false;
        let startX, startY, imageStartWidth, imageStartHeight, imageAspectRatio;
        let dragOffsets = new Map();

        // --- Referencias a Controles ---
        const artboardWidthInput = document.getElementById('artboard-width');
        const artboardHeightInput = document.getElementById('artboard-height');
        const artboardBgColorInput = document.getElementById('artboard-bg-color');
        const imageLoader = document.getElementById('image-loader');
        const numPinsInput = document.getElementById('num-pins');
        const numRowsInput = document.getElementById('num-rows');
        const addHeaderBtn = document.getElementById('add-header-btn');
        const saveImageBtn = document.getElementById('save-image-btn');
        const saveProjectBtn = document.getElementById('save-project-btn');
        const loadProjectBtn = document.getElementById('load-project-btn');
        const projectLoader = document.getElementById('project-loader');
        const deleteSelectionBtn = document.getElementById('delete-selection-btn');
        const alignmentTools = document.getElementById('alignment-tools');
        const selectionThicknessInput = document.getElementById('selection-thickness-input');
        const pinEditor = document.getElementById('pin-editor');
        const pinIdTextInput = document.getElementById('pin-id-text');
        const pinFunctionsList = document.getElementById('pin-functions-list');
        const addFunctionBtn = document.getElementById('add-function-btn');
        const groupBtn = document.getElementById('group-btn');
        const ungroupBtn = document.getElementById('ungroup-btn');

        function initializeApp() {
            addEventListeners();
            setArtboardSize(artboardWidthInput.value, artboardHeightInput.value);
            artboard.style.backgroundColor = artboardBgColorInput.value;
            centerArtboard();
        }

        function addEventListeners() {
            artboardWidthInput.addEventListener('input', onArtboardSizeInput);
            artboardHeightInput.addEventListener('input', onArtboardSizeInput);
            artboardBgColorInput.addEventListener('input', (e) => { artboard.style.backgroundColor = e.target.value; });
            imageLoader.addEventListener('change', onImageLoad);
            addHeaderBtn.addEventListener('click', addHeader);
            saveImageBtn.addEventListener('click', saveArtboardAsImage);
            saveProjectBtn.addEventListener('click', saveProject);
            loadProjectBtn.addEventListener('click', () => projectLoader.click());
            projectLoader.addEventListener('change', loadProject);
            deleteSelectionBtn.addEventListener('click', deleteSelected);
            groupBtn.addEventListener('click', groupSelection);
            ungroupBtn.addEventListener('click', ungroupSelection);
            selectionThicknessInput.addEventListener('input', () => setPinThickness(selectionGroup, selectionThicknessInput.value));
            document.getElementById('align-left-btn').addEventListener('click', () => alignElements('left'));
            document.getElementById('align-right-btn').addEventListener('click', () => alignElements('right'));
            document.getElementById('align-top-btn').addEventListener('click', () => alignElements('top'));
            document.getElementById('align-bottom-btn').addEventListener('click', () => alignElements('bottom'));
            document.getElementById('align-vcenter-btn').addEventListener('click', () => alignElements('vcenter'));
            document.getElementById('align-hcenter-btn').addEventListener('click', () => alignElements('hcenter'));
            document.getElementById('distribute-h-btn').addEventListener('click', () => distributeElements('horizontal'));
            document.getElementById('distribute-v-btn').addEventListener('click', () => distributeElements('vertical'));
            document.getElementById('tidy-h-btn').addEventListener('click', () => tidyElements('horizontal'));
            document.getElementById('tidy-v-btn').addEventListener('click', () => tidyElements('vertical'));
            document.getElementById('rotate-selection-btn').addEventListener('click', rotateSelection);
            document.getElementById('flip-selection-btn').addEventListener('click', flipSelection);
            addFunctionBtn.addEventListener('click', handleAddFunction);
            pinIdTextInput.addEventListener('input', (e) => { if (selectionGroup.length === 1 && selectionGroup[0].classList.contains('pin')) { selectionGroup[0].querySelector('.pin-id span').textContent = e.target.value; }});
            document.getElementById('rotate-pin-btn').addEventListener('click', rotateSelection);
            document.getElementById('flip-pin-btn').addEventListener('click', flipSelection);
            artboard.querySelector('.artboard-resize-handle').addEventListener('mousedown', onResizeArtboardMouseDown);
            editorArea.addEventListener('mousedown', onEditorMouseDown);
            editorArea.addEventListener('wheel', onEditorWheel);
            window.addEventListener('keydown', handleKeyPress);
            window.addEventListener('keyup', handleKeyRelease);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        // --- Lógica de la Aplicación ---

        function saveProject() { try { const serializeElements = (elementCollection) => { const serialized = []; for (const el of elementCollection) { let obj; if (el.classList.contains('pin')) { obj = { type: 'pin', left: el.offsetLeft, top: el.offsetTop, isVertical: el.classList.contains('vertical'), isFlipped: el.classList.contains('flipped'), thickness: el.style.getPropertyValue('--pin-grosor') || null, idText: el.querySelector('.pin-id span').textContent, idColor: rgbToHex(el.querySelector('.pin-id').style.backgroundColor), functions: Array.from(el.querySelectorAll('.pin-function')).map(func => ({ text: func.querySelector('span').textContent, color: rgbToHex(func.style.backgroundColor) })) }; } else if (el.classList.contains('image-wrapper')) { const img = el.querySelector('img'); obj = { type: 'image', left: el.offsetLeft, top: el.offsetTop, width: el.offsetWidth, height: el.offsetHeight, imageData: img.src }; } else if (el.classList.contains('group-wrapper')) { obj = { type: 'group', left: el.offsetLeft, top: el.offsetTop, width: el.offsetWidth, height: el.offsetHeight, elements: serializeElements(el.children) }; } if(obj) serialized.push(obj); } return serialized; }; const projectData = { version: '1.1-json', artboard: { width: artboard.offsetWidth, height: artboard.offsetHeight, backgroundColor: artboard.style.backgroundColor }, elements: serializeElements(Array.from(artboard.children).filter(c => !c.classList.contains('artboard-resize-handle'))) }; const projectJSON = JSON.stringify(projectData, null, 2); const blob = new Blob([projectJSON], { type: 'application/json' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = "mi_pinout.pop"; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); } catch (error) { console.error("¡ERROR! Ocurrió una excepción en la función saveProject:", error); alert("Ocurrió un error al intentar guardar el proyecto. Revisa la consola para más detalles."); } }
        function loadProject(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const projectData = JSON.parse(e.target.result); rebuildArtboard(projectData); } catch (err) { alert('Error al leer el archivo. El archivo no es un proyecto JSON válido.'); console.error("Error parsing project file:", err); } }; reader.readAsText(file); projectLoader.value = ''; }
        function rebuildArtboard(projectData) { deselectAll(); while (artboard.children.length > 1) { artboard.removeChild(artboard.firstChild); } setArtboardSize(projectData.artboard.width, projectData.artboard.height); artboard.style.backgroundColor = projectData.artboard.backgroundColor; artboardBgColorInput.value = projectData.artboard.backgroundColor; const buildElements = (elementsData, parent) => { for (const data of elementsData) { let el; if (data.type === 'pin') { el = document.createElement('div'); el.className = 'pin'; if (data.isVertical) el.classList.add('vertical'); if (data.isFlipped) el.classList.add('flipped'); if (data.thickness) el.style.setProperty('--pin-grosor', data.thickness); let functionsHtml = data.functions.map(f => `<div class="pin-function" style="background-color: ${f.color};"><span>${f.text}</span></div>`).join(''); el.innerHTML = `<div class="pin-id" style="background-color: ${data.idColor};"><span>${data.idText}</span></div><div class="pin-label-container">${functionsHtml}</div>`; el.addEventListener('mousedown', handleElementSelection); } else if (data.type === 'image') { el = document.createElement('div'); el.className = 'image-wrapper'; const img = document.createElement('img'); img.src = data.imageData; const handle = document.createElement('div'); handle.className = 'image-resize-handle'; el.append(img, handle); el.addEventListener('mousedown', handleElementSelection); } else if (data.type === 'group') { el = document.createElement('div'); el.className = 'group-wrapper'; el.addEventListener('mousedown', handleElementSelection); buildElements(data.elements, el); } if (el) { el.style.left = `${data.left}px`; el.style.top = `${data.top}px`; if (data.width) el.style.width = `${data.width}px`; if (data.height) el.style.height = `${data.height}px`; parent.appendChild(el); } } }; buildElements(projectData.elements, artboard); }
        function getEmbeddedCss() { const cssRules = []; for (const sheet of document.styleSheets) { try { if (sheet.cssRules) { for (const rule of sheet.cssRules) { cssRules.push(rule.cssText); } } } catch (e) { console.warn("Could not read CSS rule from stylesheet:", e); } } return cssRules.join('\n'); }
        function saveArtboardAsImage() { const selectedElements = Array.from(document.querySelectorAll('.selected')); selectedElements.forEach(el => el.classList.remove('selected')); const width = artboard.offsetWidth; const height = artboard.offsetHeight; const artboardHtml = artboard.innerHTML; const embeddedCss = getEmbeddedCss() + ` #artboard { background-color: ${artboard.style.backgroundColor}; }`; const svgData = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml"><style>${embeddedCss}</style>${artboardHtml}</div></foreignObject></svg>`; const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' }); const url = URL.createObjectURL(blob); const img = new Image(); img.onload = () => { const canvas = document.createElement('canvas'); const scale = 2; canvas.width = width * scale; canvas.height = height * scale; const ctx = canvas.getContext('2d'); ctx.scale(scale, scale); ctx.drawImage(img, 0, 0); const link = document.createElement('a'); link.href = canvas.toDataURL('image/png'); link.download = 'pinout-design.png'; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); selectedElements.forEach(el => el.classList.add('selected')); }; img.onerror = (e) => { console.error("Failed to load SVG as an image.", e); alert("Sorry, there was an error saving the image."); selectedElements.forEach(el => el.classList.add('selected')); }; img.src = url; }
        function groupSelection() { if (selectionGroup.length <= 1) return; const groupWrapper = document.createElement('div'); groupWrapper.className = 'group-wrapper'; const rects = selectionGroup.map(el => ({ left: el.offsetLeft, top: el.offsetTop, right: el.offsetLeft + el.offsetWidth, bottom: el.offsetTop + el.offsetHeight })); const minX = Math.min(...rects.map(r => r.left)); const minY = Math.min(...rects.map(r => r.top)); const maxX = Math.max(...rects.map(r => r.right)); const maxY = Math.max(...rects.map(r => r.bottom)); groupWrapper.style.left = `${minX}px`; groupWrapper.style.top = `${minY}px`; groupWrapper.style.width = `${maxX - minX}px`; groupWrapper.style.height = `${maxY - minY}px`; selectionGroup.forEach(el => { el.style.left = `${el.offsetLeft - minX}px`; el.style.top = `${el.offsetTop - minY}px`; groupWrapper.appendChild(el); }); artboard.appendChild(groupWrapper); groupWrapper.addEventListener('mousedown', handleElementSelection); deselectAll(); selectionGroup = [groupWrapper]; groupWrapper.classList.add('selected'); updateContextualUI(); }
        function ungroupSelection() { const groupsToUngroup = selectionGroup.filter(el => el.classList.contains('group-wrapper')); if (groupsToUngroup.length === 0) return; const releasedElements = []; groupsToUngroup.forEach(group => { const groupLeft = group.offsetLeft; const groupTop = group.offsetTop; while(group.firstChild) { const child = group.firstChild; child.style.left = `${child.offsetLeft + groupLeft}px`; child.style.top = `${child.offsetTop + groupTop}px`; artboard.appendChild(child); releasedElements.push(child); } group.remove(); }); deselectAll(); selectionGroup = releasedElements; selectionGroup.forEach(el => el.classList.add('selected')); updateContextualUI(); }
        function createPinElement(idText, labelText, x, y) { const pin = document.createElement('div'); pin.className = 'pin'; pin.style.left = `${x}px`; pin.style.top = `${y}px`; pin.innerHTML = `<div class="pin-id" style="background-color: #777;"><span>${idText}</span></div><div class="pin-label-container"><div class="pin-function" style="background-color: #ffffff;"><span>${labelText}</span></div></div>`; artboard.appendChild(pin); pin.addEventListener('mousedown', handleElementSelection); }
        function updateEditorPanel(pin) { if (!pin || !pin.classList.contains('pin')) { pinFunctionsList.innerHTML = ''; return; }; pinIdTextInput.value = pin.querySelector('.pin-id span').textContent; pinFunctionsList.innerHTML = ''; const functions = pin.querySelectorAll('.pin-function'); functions.forEach((funcEl) => { const text = funcEl.querySelector('span').textContent; const color = rgbToHex(funcEl.style.backgroundColor); const row = document.createElement('div'); row.className = 'function-editor-row'; row.innerHTML = `<input type="text" value="${text}"><input type="color" value="${color}"><button class="delete-function-btn">X</button>`; pinFunctionsList.appendChild(row); const textInput = row.querySelector('input[type="text"]'); const colorInput = row.querySelector('input[type="color"]'); const deleteBtn = row.querySelector('.delete-function-btn'); textInput.addEventListener('input', (e) => { funcEl.querySelector('span').textContent = e.target.value; }); colorInput.addEventListener('input', (e) => { funcEl.style.backgroundColor = e.target.value; }); deleteBtn.addEventListener('click', () => { if (pin.querySelectorAll('.pin-function').length > 1) { funcEl.remove(); updateEditorPanel(pin); } else { alert("Un pin debe tener al menos una función."); } }); }); }
        function handleAddFunction() { if (selectionGroup.length !== 1 || !selectionGroup[0].classList.contains('pin')) return; const pin = selectionGroup[0]; const container = pin.querySelector('.pin-label-container'); const newFunc = document.createElement('div'); newFunc.className = 'pin-function'; newFunc.style.backgroundColor = '#ffffff'; newFunc.innerHTML = `<span>Nueva Función</span>`; container.appendChild(newFunc); updateEditorPanel(pin); }
        function updateContextualUI() { const selectionSize = selectionGroup.length; const containsPins = selectionGroup.some(el => el.classList.contains('pin')); const containsGroups = selectionGroup.some(el => el.classList.contains('group-wrapper')); const onlyOnePinSelected = selectionSize === 1 && containsPins; pinEditor.style.display = onlyOnePinSelected ? 'block' : 'none'; alignmentTools.style.display = selectionSize > 0 ? 'block' : 'none'; deleteSelectionBtn.style.display = selectionSize > 0 ? 'block' : 'none'; groupBtn.disabled = selectionSize <= 1; ungroupBtn.disabled = !containsGroups; if (onlyOnePinSelected) { updateEditorPanel(selectionGroup[0]); } else { pinFunctionsList.innerHTML = ''; } if (selectionSize > 0) { const containsImagesOrGroups = selectionGroup.some(el => el.classList.contains('image-wrapper') || el.classList.contains('group-wrapper')); const pinSpecificControls = alignmentTools.querySelectorAll('.pin-specific-control'); const showPinControls = containsPins && !containsImagesOrGroups; pinSpecificControls.forEach(c => c.style.display = showPinControls ? 'block' : 'none'); } }
        function setPinThickness(pins, value) { if (pins.length === 0) return; const thickness = parseInt(value); const styleValue = (!isNaN(thickness) && thickness > 0) ? `${thickness}px` : null; pins.forEach(el => { if (el.classList.contains('pin')) { el.style.setProperty('--pin-grosor', styleValue); } }); }
        
        /**
         * CAMBIO: Lógica modificada para seleccionar el grupo padre al hacer clic en un hijo.
         */
        function handleElementSelection(e) {
            e.stopPropagation();

            // Caso especial para el handle de redimensionar imagen
            if (e.target.classList.contains('image-resize-handle')) {
                isResizingImage = true;
                startX = e.clientX;
                startY = e.clientY;
                const wrapper = e.currentTarget;
                imageStartWidth = wrapper.offsetWidth;
                imageStartHeight = wrapper.offsetHeight;
                const img = wrapper.querySelector('img');
                imageAspectRatio = img.naturalWidth / img.naturalHeight;
                return;
            }

            // --- NUEVA LÓGICA ---
            // Determinar cuál es el objeto principal a seleccionar (el elemento o su grupo padre)
            let selectableTarget = e.currentTarget;
            while (selectableTarget.parentElement && selectableTarget.parentElement.id !== 'artboard') {
                selectableTarget = selectableTarget.parentElement;
            }

            const isMultiSelect = e.ctrlKey || e.metaKey;
            const isTargetAlreadySelected = selectableTarget.classList.contains('selected');

            if (!isMultiSelect && !isTargetAlreadySelected) {
                deselectAll();
            }

            const index = selectionGroup.indexOf(selectableTarget);
            if (isMultiSelect) {
                if (index > -1) {
                    selectionGroup.splice(index, 1);
                    selectableTarget.classList.remove('selected');
                } else {
                    selectionGroup.push(selectableTarget);
                    selectableTarget.classList.add('selected');
                }
            } else if (index === -1) {
                selectionGroup.push(selectableTarget);
                selectableTarget.classList.add('selected');
            }
            
            updateContextualUI();
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            dragOffsets.clear();
            selectionGroup.forEach(el => {
                dragOffsets.set(el, { x: el.offsetLeft, y: el.offsetTop });
            });
        }
        
        function tidyElements(mode) { if (selectionGroup.length < 2) return; const gap = parseInt(document.getElementById('tidy-gap-input').value) || 0; if (mode === 'vertical') { const sorted = selectionGroup.slice().sort((a,b) => a.offsetTop - b.offsetTop); const targetLeft = sorted[0].offsetLeft; let currentTop = sorted[0].offsetTop; sorted.forEach(el => { el.style.left = `${targetLeft}px`; el.style.top = `${currentTop}px`; currentTop += el.offsetHeight + gap; }); } else { const sorted = selectionGroup.slice().sort((a,b) => a.offsetLeft - b.offsetLeft); const targetTop = sorted[0].offsetTop; let currentLeft = sorted[0].offsetLeft; sorted.forEach(el => { el.style.top = `${targetTop}px`; el.style.left = `${currentLeft}px`; currentLeft += el.offsetWidth + gap; }); } }
        function deselectAll() { selectionGroup.forEach(p => p.classList.remove('selected')); selectionGroup = []; updateContextualUI(); }
        function handleKeyPress(e) { const activeEl = document.activeElement; if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) return; if (e.key === 'Delete' || e.key === 'Backspace') { e.preventDefault(); deleteSelected(); } if (e.key === ' ' && !isPanning) { e.preventDefault(); editorArea.classList.add('panning'); } if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'g' && !e.shiftKey) { e.preventDefault(); groupSelection(); } if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'g') { e.preventDefault(); ungroupSelection(); } }
        function handleKeyRelease(e) { if (e.key === ' ') { editorArea.classList.remove('panning'); } }
        function deleteSelected() { selectionGroup.forEach(el => el.remove()); deselectAll(); }
        function rotateSelection() { if (selectionGroup.length < 1) return; selectionGroup.forEach(el => { if (el.classList.contains('pin')) { el.classList.toggle('vertical'); } }); updateContextualUI(); }
        function flipSelection() { if (selectionGroup.length < 1) return; selectionGroup.forEach(el => { if (el.classList.contains('pin')) { el.classList.toggle('flipped'); } }); }
        function createImageElement(file, offset = 0) { const wrapper = document.createElement('div'); wrapper.className = 'image-wrapper'; const img = document.createElement('img'); const handle = document.createElement('div'); handle.className = 'image-resize-handle'; wrapper.append(img, handle); artboard.appendChild(wrapper); wrapper.addEventListener('mousedown', handleElementSelection); const reader = new FileReader(); reader.onload = (e) => { img.src = e.target.result; img.onload = () => { const aspectRatio = img.naturalWidth / img.naturalHeight; const initialWidth = 250; wrapper.style.width = `${initialWidth}px`; wrapper.style.height = `${initialWidth / aspectRatio}px`; wrapper.style.left = `${50 + offset * 20}px`; wrapper.style.top = `${50 + offset * 20}px`; }; }; reader.readAsDataURL(file); }
        function onImageLoad(e) { const files = e.target.files; if (!files) return; deselectAll(); for (let i = 0; i < files.length; i++) { createImageElement(files[i], i); } e.target.value = ''; }
        function setArtboardSize(width, height) { artboard.style.width = `${width}px`; artboard.style.height = `${height}px`; if (document.activeElement !== artboardWidthInput) artboardWidthInput.value = Math.round(width); if (document.activeElement !== artboardHeightInput) artboardHeightInput.value = Math.round(height); }
        function centerArtboard() { const artboardW = artboard.offsetWidth, artboardH = artboard.offsetHeight; viewTranslateX = (editorArea.clientWidth - artboardW) / 2; viewTranslateY = (editorArea.clientHeight - artboardH) / 2; viewScale = 1; updateViewTransform(); }
        function onArtboardSizeInput() { const newWidth = parseInt(artboardWidthInput.value) || artboard.offsetWidth; const newHeight = parseInt(artboardHeightInput.value) || artboard.offsetHeight; setArtboardSize(newWidth, newHeight); }
        function onResizeArtboardMouseDown(e) { e.stopPropagation(); isResizingArtboard = true; startX = e.clientX; startY = e.clientY; let artboardStartWidth = artboard.offsetWidth; let artboardStartHeight = artboard.offsetHeight; function onResizeArtboardMouseMove(ev) { if (!isResizingArtboard) return; const dx = (ev.clientX - startX) / viewScale; const dy = (ev.clientY - startY) / viewScale; setArtboardSize(artboardStartWidth + dx, artboardStartHeight + dy); } function onResizeArtboardMouseUp() { isResizingArtboard = false; document.removeEventListener('mousemove', onResizeArtboardMouseMove); document.removeEventListener('mouseup', onResizeArtboardMouseUp);} document.addEventListener('mousemove', onResizeArtboardMouseMove); document.addEventListener('mouseup', onResizeArtboardMouseUp);}
        function updateViewTransform() { artboard.style.transform = `translate(${viewTranslateX}px, ${viewTranslateY}px) scale(${viewScale})`; }
        function onEditorWheel(e) { e.preventDefault(); const rect = editorArea.getBoundingClientRect(); const mouseX = e.clientX - rect.left, mouseY = e.clientY - rect.top; const scaleAmount = 1.1, oldScale = viewScale; viewScale = e.deltaY < 0 ? viewScale * scaleAmount : viewScale / scaleAmount; viewTranslateX = mouseX - (mouseX - viewTranslateX) * (viewScale / oldScale); viewTranslateY = mouseY - (mouseY - viewTranslateY) * (viewScale / oldScale); updateViewTransform(); }
        function onEditorMouseDown(e) { if (e.button === 1) { e.preventDefault(); isPanning = true; startX = e.clientX; startY = e.clientY; editorArea.classList.add('panning'); return; } if (e.button === 0) { const target = e.target; if (target === artboard || target === editorArea) { e.preventDefault(); isSelecting = true; deselectAll(); selectionBox.style.display = 'block'; const rect = editorArea.getBoundingClientRect(); startX = e.clientX - rect.left; startY = e.clientY - rect.top; selectionBox.style.left = `${startX}px`; selectionBox.style.top = `${startY}px`; selectionBox.style.width = '0px'; selectionBox.style.height = '0px'; } } }
        function onMouseMove(e) { if (isSelecting) { const rect = editorArea.getBoundingClientRect(); const currentX = e.clientX - rect.left; const currentY = e.clientY - rect.top; selectionBox.style.left = `${Math.min(startX, currentX)}px`; selectionBox.style.top = `${Math.min(startY, currentY)}px`; selectionBox.style.width = `${Math.abs(currentX - startX)}px`; selectionBox.style.height = `${Math.abs(currentY - startY)}px`; } else if (isDragging) { const dx = (e.clientX - startX) / viewScale, dy = (e.clientY - startY) / viewScale; selectionGroup.forEach(el => { const offset = dragOffsets.get(el); if (offset) { el.style.left = `${offset.x + dx}px`; el.style.top = `${offset.y + dy}px`; } }); } else if (isPanning) { viewTranslateX += e.clientX - startX; viewTranslateY += e.clientY - startY; startX = e.clientX; startY = e.clientY; updateViewTransform(); } else if (isResizingImage) { const dx = (e.clientX - startX) / viewScale; const newWidth = imageStartWidth + dx; if (newWidth > 20) { selectionGroup[0].style.width = `${newWidth}px`; selectionGroup[0].style.height = `${newWidth / imageAspectRatio}px`; } } }
        function onMouseUp(e) { if (isSelecting) { checkSelectionBox(selectionBox.getBoundingClientRect()); updateContextualUI(); } if (isPanning) { editorArea.classList.remove('panning'); } isPanning = isDragging = isSelecting = isResizingArtboard = isResizingImage = false; selectionBox.style.display = 'none'; }
        function checkSelectionBox(boxRect) { deselectAll(); const newSelection = []; const allSelectable = artboard.querySelectorAll('.pin, .image-wrapper, .group-wrapper'); allSelectable.forEach(el => { if (el.parentElement.id === 'artboard') { const elRect = el.getBoundingClientRect(); const inBox = !(boxRect.right < elRect.left || boxRect.left > elRect.right || boxRect.bottom < elRect.top || boxRect.top > elRect.bottom); if (inBox) { newSelection.push(el); el.classList.add('selected'); } } }); selectionGroup = newSelection; }
        function addHeader() { const numPins = parseInt(numPinsInput.value) || 1; const numRows = parseInt(numRowsInput.value) || 1; const startX = 20, startY = 20, pinSpacingY = 40, rowSpacingX = 250; for (let row = 0; row < numRows; row++) { for (let i = 0; i < numPins; i++) { createPinElement(`P${row * numPins + i}`, 'FUNCIÓN', startX + row * rowSpacingX, startY + i * pinSpacingY); } } }
        function alignElements(mode) { if (selectionGroup.length < 2) return; let target; switch(mode) { case 'left': target = Math.min(...selectionGroup.map(p => p.offsetLeft)); selectionGroup.forEach(p => p.style.left = `${target}px`); break; case 'right': target = Math.max(...selectionGroup.map(p => p.offsetLeft + p.offsetWidth)); selectionGroup.forEach(p => p.style.left = `${target - p.offsetWidth}px`); break; case 'top': target = Math.min(...selectionGroup.map(p => p.offsetTop)); selectionGroup.forEach(p => p.style.top = `${target}px`); break; case 'bottom': target = Math.max(...selectionGroup.map(p => p.offsetTop + p.offsetHeight)); selectionGroup.forEach(p => p.style.top = `${target - p.offsetHeight}px`); break; case 'hcenter': target = selectionGroup[0].offsetTop + selectionGroup[0].offsetHeight / 2; selectionGroup.forEach(p => p.style.top = `${target - p.offsetHeight / 2}px`); break; case 'vcenter': target = selectionGroup[0].offsetLeft + selectionGroup[0].offsetWidth / 2; selectionGroup.forEach(p => p.style.left = `${target - p.offsetWidth / 2}px`); break; } }
        function distributeElements(mode) { if (selectionGroup.length < 3) return; if (mode === 'horizontal') { const sorted = selectionGroup.slice().sort((a,b) => a.offsetLeft - b.offsetLeft); const first = sorted[0], last = sorted[sorted.length - 1]; const totalRange = last.offsetLeft - first.offsetLeft; const totalWidth = sorted.slice(1, -1).reduce((sum, p) => sum + p.offsetWidth, 0); const spacing = (totalRange - totalWidth) / (sorted.length - 1); let currentPos = first.offsetLeft + first.offsetWidth + spacing; for (let i = 1; i < sorted.length - 1; i++) { sorted[i].style.left = `${currentPos}px`; currentPos += sorted[i].offsetWidth + spacing; } } else { const sorted = selectionGroup.slice().sort((a,b) => a.offsetTop - b.offsetTop); const first = sorted[0], last = sorted[sorted.length - 1]; const totalRange = last.offsetTop - first.offsetTop; const totalHeight = sorted.slice(1, -1).reduce((sum, p) => sum + p.offsetHeight, 0); const spacing = (totalRange - totalHeight) / (sorted.length - 1); let currentPos = first.offsetTop + first.offsetHeight + spacing; for (let i = 1; i < sorted.length - 1; i++) { sorted[i].style.top = `${currentPos}px`; currentPos += sorted[i].offsetHeight + spacing; } } }
        function rgbToHex(rgb) { if (!rgb || !rgb.startsWith('rgb')) return '#ffffff'; let [r, g, b] = rgb.match(/\d+/g).map(Number); return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase(); }
        
        initializeApp();
    });
    </script>
</body>
</html>
